name: Pipeline

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  ci:
    runs-on: ubuntu-latest
    environment: DEV
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Run tests
        run: mvn -B test

      - name: Code analisys
        run: mvn clean install -e sonar:sonar -Dsonar.host.url=https://sonarcloud.io -Dsonar.login=${{ secrets.SONAR_TOKEN }} -Dsonar.projectKey=michel-dos-santos_lanchonete-do-bairro-postech-fiap -Dsonar.organization=michel-dos-santos

  cd:
    runs-on: ubuntu-latest
    environment: DEV
    needs: ci
    steps:
      - name: "🐋 docker login"
        uses: docker/login-action@v3.0.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

      - name: "🖼️ Build docker image adapter-rest-fast-food:develop"
        if: ${{ contains(github.ref, 'develop') }}
        run: |
          docker build . --file adapter-rest/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:develop

      - name: "🚀 docker push adapter-rest-fast-food:develop"
        if: ${{ contains(github.ref, 'develop') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:develop

      - name: "🖼️ Build docker image adapter-consumer-billing-fast-food:develop"
        if: ${{ contains(github.ref, 'develop') }}
        run: |
          docker build . --file adapter-consumer-billing/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:develop

      - name: "🚀 docker push adapter-consumer-billing-fast-food:develop"
        if: ${{ contains(github.ref, 'develop') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:develop

      - name: "🖼️ Build docker image adapter-rest-fast-food:feature"
        if: ${{ contains(github.ref, 'feature') }}
        run: |
          docker build . --file adapter-rest/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:feature

      - name: "🚀 docker push adapter-rest-fast-food:feature"
        if: ${{ contains(github.ref, 'feature') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:feature

      - name: "🖼️ Build docker image adapter-consumer-billing-fast-food:feature"
        if: ${{ contains(github.ref, 'feature') }}
        run: |
          docker build . --file adapter-consumer-billing/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:feature

      - name: "🚀 docker push adapter-consumer-billing-fast-food:feature"
        if: ${{ contains(github.ref, 'feature') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:feature

      - name: "🖼️ Build docker image adapter-rest-fast-food:hotfix"
        if: ${{ contains(github.ref, 'hotfix') }}
        run: |
          docker build . --file adapter-rest/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:hotfix

      - name: "🚀 docker push adapter-rest-fast-food:hotfix"
        if: ${{ contains(github.ref, 'hotfix') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:hotfix

      - name: "🖼️ Build docker image adapter-consumer-billing-fast-food:hotfix"
        if: ${{ contains(github.ref, 'hotfix') }}
        run: |
          docker build . --file adapter-consumer-billing/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:hotfix

      - name: "🚀 docker push adapter-consumer-billing-fast-food:hotfix"
        if: ${{ contains(github.ref, 'hotfix') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:hotfix

      - name: "🖼️ Build docker image adapter-rest-fast-food:master"
        if: ${{ contains(github.ref, 'master') }}
        run: |
          docker build . --file adapter-rest/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:master

      - name: "🚀 docker push adapter-rest-fast-food:master"
        if: ${{ contains(github.ref, 'master') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:master

      - name: "🖼️ Build docker image adapter-consumer-billing-fast-food:master"
        if: ${{ contains(github.ref, 'master') }}
        run: |
          docker build . --file adapter-consumer-billing/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:master

      - name: "🚀 docker push adapter-consumer-billing-fast-food:master"
        if: ${{ contains(github.ref, 'master') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:master

      - name: "🖼️ Build docker image adapter-rest-fast-food:release"
        if: ${{ contains(github.ref, 'release') }}
        run: |
          docker build . --file adapter-rest/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:release

      - name: "🚀 docker push adapter-rest-fast-food:release"
        if: ${{ contains(github.ref, 'release') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-rest-fast-food:release

      - name: "🖼️ Build docker image adapter-consumer-billing-fast-food:release"
        if: ${{ contains(github.ref, 'release') }}
        run: |
          docker build . --file adapter-consumer-billing/Dockerfile --tag ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:release

      - name: "🚀 docker push adapter-consumer-billing-fast-food:release"
        if: ${{ contains(github.ref, 'release') }}
        run: |
          docker push ${{ secrets.DOCKER_USER }}/adapter-consumer-billing-fast-food:release

      





 #
 # unit-tests:
 #   uses: ./.github/workflows/unit-tests.yml
 # code-analisys:
 #   needs: unit-tests
 #   uses: ./.github/workflows/code-analisys.yml
 #   secrets: inherit
 # build:
 #   needs: code-analisys
 #   uses: ./.github/workflows/build.yml
 #   secrets: inherit
 # publish-docker-feature:
 #   needs: build
 #   if: ${{ contains(github.ref, 'feature') }}
 #   uses: ./.github/workflows/publish-docker-feature.yml
 #   secrets: inherit
 # publish-docker-develop:
 #   needs: build
 #   if: ${{ contains(github.ref, 'develop') }}
 #   uses: ./.github/workflows/publish-docker-develop.yml
 #   secrets: inherit
 # publish-docker-hotfix:
 #   needs: build
 #   if: ${{ contains(github.ref, 'hotfix') }}
 #   uses: ./.github/workflows/publish-docker-hotfix.yml
 #   secrets: inherit
 # publish-docker-release:
 #   needs: build
 #   if: ${{ contains(github.ref, 'release') }}
 #   uses: ./.github/workflows/publish-docker-release.yml
 #   secrets: inherit
 # publish-docker-master:
 #   needs: build
 #   if: ${{ contains(github.ref, 'master') }}
 #   uses: ./.github/workflows/publish-docker-master.yml
 #   secrets: inherit
 # deploy:
 #   needs: [publish-docker-feature, publish-docker-develop, publish-docker-hotfix, publish-docker-release, publish-docker-master]
 #   if: ${{ always() && contains(needs.*.result, 'success') && !contains(needs.*.result, 'failure') }}
 #   uses: ./.github/workflows/deploy.yml
 #   secrets: inherit